generator kysely {
    provider = "prisma-kysely"

    output       = "../../src/db"
    fileName     = "types.ts"
    enumFileName = "enums.ts"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

// players

model account {
    id Int @id @default(autoincrement())

    username String  @unique
    password String
    password_updated DateTime?
    email    String?
    oauth_provider  String?

    registration_ip   String?
    registration_date DateTime @default(now())

    muted_until  DateTime?
    banned_until DateTime?

    staffmodlevel Int @default(0)

    notes         String?   @db.Text
    notes_updated DateTime?

    members Boolean @default(false)

    // Whether 2FA is enabled
    tfa_enabled Boolean @default(false)
    // To prevent replay attacks
    tfa_last_code Int @default(0)
    // Secret key for code generation
    tfa_secret_base32 String?
    // How many incorrect attempts have been made in a row
    tfa_incorrect_attempts Int @default(0)
}

// account logged in status
model account_login {
    account_id Int
    profile String

    // current login
    logged_in  Int       @default(0)
    login_time DateTime?

    // last logout
    logged_out  Int       @default(0)
    logout_time DateTime?

    @@unique([account_id, profile])
}

model session {
    uuid String @id

    account_id Int
    profile    String

    world     Int
    timestamp DateTime
    uid       Int
    ip        String?
}

// attempts (monitoring abuse)
model login {
    uuid       String   @id
    account_id Int
    world      Int
    timestamp  DateTime
    uid        Int
    ip         String?
}

model ipban {
    ip String @id
}

// todo: rename this to e.g. session_log one day
model account_session {
    id Int @id @default(autoincrement())

    account_id   Int
    world        Int    @default(0)
    profile      String @default("main")
    session_uuid String

    timestamp  DateTime
    coord      Int
    event      String
    event_type Int      @default(-1)
}

model tag {
    id Int @id @default(autoincrement())

    name String
    color String?
}

model account_tag {
    tag_id Int
    account_id Int

    @@id([account_id, tag_id])
}

model wealth_event {
    id Int @id @default(autoincrement())

    timestamp   DateTime
    coord       Int
    world       Int     @default(0)
    profile     String  @default("main")

    event_type          Int     @default(-1)

    account_id         Int
    account_session    String
    account_items      String  @db.MediumText
    account_value      Int

    recipient_id         Int?
    recipient_session     String?
    recipient_items      String? @db.MediumText
    recipient_value      Int?

    @@index([recipient_id])
}

// website

model newspost {
    id Int @id @default(autoincrement())

    category Int
    title    String
    content  String  @db.MediumText
    slug     String?

    created DateTime @default(now())
    updated DateTime @default(now()) @updatedAt
}

model hiscore {
    account_id Int
    profile    String   @default("main")
    type       Int
    level      Int
    value      Int
    playtime   Int      @default(0)
    date       DateTime @default(now()) @updatedAt

    @@id([account_id, profile, type])
}

// upped value size to 8 bytes used for larger values e.g. total xp tracking
model hiscore_large {
    account_id Int
    profile    String   @default("main")
    type       Int
    level      Int
    value      BigInt
    playtime   Int      @default(0)
    date       DateTime @default(now()) @updatedAt

    @@id([account_id, profile, type])
}

// social

model friendlist {
    account_id        Int
    profile           String @default("main")
    friend_account_id Int

    created DateTime @default(now())

    @@id([account_id, profile, friend_account_id])
}

model ignorelist {
    account_id Int
    profile    String   @default("main")
    value      String
    created    DateTime @default(now())

    @@id([account_id, profile, value])
}

model public_chat {
    id Int @id @default(autoincrement())

    account_id Int
    profile    String

    world     Int
    timestamp DateTime
    coord     Int
    message   String
}

model private_chat {
    id Int @id @default(autoincrement())

    account_id Int
    profile    String

    timestamp     DateTime
    coord         Int
    to_account_id Int
    message       String
}

model report {
    id Int @id @default(autoincrement())

    account_id Int
    profile    String

    world     Int
    timestamp DateTime
    coord     Int

    offender String
    reason   Int

    reviewed Boolean @default(false)
}

model input_report {
    id           Int      @id @default(autoincrement())
    account_id   Int
    timestamp    DateTime
    session_uuid String
}

model input_report_event_raw {
    input_report_id Int
    seq             Int

    coord Int
    data  Bytes

    @@id([input_report_id, seq])
}

model message_thread {
    id Int @id @default(autoincrement())

    to_account_id     Int?
    from_account_id   Int
    last_message_from Int
    subject           String
    created           DateTime @default(now())
    updated           DateTime @default(now())
    messages          Int @default(1)
    closed            DateTime?
    closed_by         Int?
    marked_spam       DateTime?
    marked_spam_by    Int?
}

model message {
    id Int @id @default(autoincrement())

    thread_id   Int
    sender_id   Int
    sender_ip   String
    content     String @db.Text
    created     DateTime @default(now())
    edited      DateTime?
    edited_by   Int?
    deleted     DateTime?
    deleted_by  Int?
}

model message_tag {
    tag_id      Int
    thread_id   Int

    @@id([thread_id, tag_id])
}

model message_status {
  id Int @id @default(autoincrement())

  thread_id  Int
  account_id Int
  read       DateTime?
  deleted    DateTime?
}

model mod_action {
    id Int @id @default(autoincrement())

    account_id Int
    target_id  Int?

    action_id Int
    data      String?
    ip        String?
    timestamp DateTime @default(now())
}

// =============================================================================
// BOT CHARACTER SYSTEM
// =============================================================================
// Unified schema combining:
// - AzerothCore character structure (WoW compatibility)
// - RuneScape bot fields
// - Bot-manager statistics and memory
//
// This allows the same character to exist in multiple game worlds with
// shared identity but game-specific stats.

model bot_character {
    id         Int    @id @default(autoincrement())
    account_id Int
    profile    String @default("main")

    // =========================================================================
    // CORE IDENTITY (shared across games)
    // =========================================================================
    name           String            // Display name (max 12 chars for WoW compat)
    personality    String?  @db.Text // Free-form personality description
    personality_preset String?       // Preset key: friendly_helper, toddler, etc.
    backstory      String?  @db.Text // Character backstory

    // Identity dates
    birthday       String?           // MM-DD format
    playing_since  Int?              // Year started (e.g., 2004)
    creation_date  DateTime @default(now())

    // =========================================================================
    // APPEARANCE (AzerothCore compatible)
    // =========================================================================
    // WoW-specific
    wow_race       Int?              // ChrRaces.dbc reference
    wow_class      Int?              // ChrClasses.dbc reference
    wow_gender     Int      @default(0)  // 0=Male, 1=Female
    wow_skin       Int      @default(0)
    wow_face       Int      @default(0)
    wow_hair_style Int      @default(0)
    wow_hair_color Int      @default(0)
    wow_facial     Int      @default(0)

    // RuneScape-specific appearance (stored as JSON for flexibility)
    rs_appearance  String?  @db.Text // JSON: {head, body, arms, hands, legs, feet, hair, jaw}

    // =========================================================================
    // PROGRESSION (game-specific)
    // =========================================================================
    // WoW
    wow_level      Int      @default(1)
    wow_xp         Int      @default(0)
    wow_money      Int      @default(0)  // Copper
    wow_health     Int      @default(100)
    wow_mana       Int      @default(0)

    // RuneScape (levels stored in hiscore table, this is summary)
    rs_combat_level Int     @default(3)
    rs_total_level  Int     @default(32)
    rs_coins        Int     @default(0)

    // =========================================================================
    // LOCATION (game-specific)
    // =========================================================================
    // WoW
    wow_map        Int?              // Map ID
    wow_zone       Int?              // Zone ID
    wow_x          Float?
    wow_y          Float?
    wow_z          Float?
    wow_orientation Float?

    // RuneScape
    rs_world       Int?              // World/server number
    rs_x           Int?              // World X coordinate
    rs_z           Int?              // World Z coordinate (Y in 3D)
    rs_plane       Int      @default(0)  // Height plane (0-3)

    // =========================================================================
    // STATUS FLAGS
    // =========================================================================
    online         Boolean  @default(false)
    last_login     DateTime?
    last_logout    DateTime?
    total_playtime Int      @default(0)  // Seconds

    // Game-specific status
    wow_online     Boolean  @default(false)
    rs_online      Boolean  @default(false)

    // =========================================================================
    // HARDCORE MODE (RuneScape specific)
    // =========================================================================
    hardcore_mode  Boolean  @default(false)
    death_count    Int      @default(0)
    deleted_at     DateTime?  // Set when hardcore character dies

    // Janitor-specific config (only if personality_preset = 'hardcore_janitor')
    janitor_home_city       String?
    janitor_burn_pile_x     Int?
    janitor_burn_pile_z     Int?
    janitor_collection_radius Int?
    janitor_items_burned    Int      @default(0)  // Lifetime stat

    // =========================================================================
    // BOT MEMORY (JSON blobs for flexibility)
    // =========================================================================
    // Item knowledge: ground spawns, monster drops, recipes
    item_memory    String?  @db.MediumText  // JSON: ItemMemoryData

    // Location knowledge: visited places, directions heard
    location_memory String? @db.MediumText  // JSON: LocationMemoryData

    // Social memory: players met, relationships, conversations
    social_memory  String?  @db.MediumText  // JSON: {friends, enemies, conversations}

    // =========================================================================
    // GATEWAY STATUS (live bot status from gateway)
    // =========================================================================
    gateway_status      String?  // 'active', 'stale', 'offline'
    gateway_last_update DateTime?
    gateway_session_id  String?

    // =========================================================================
    // STATISTICS
    // =========================================================================
    // Combat stats
    total_kills         Int     @default(0)
    total_deaths        Int     @default(0)
    pvp_kills           Int     @default(0)
    pvp_deaths          Int     @default(0)

    // Social stats
    messages_sent       Int     @default(0)
    messages_received   Int     @default(0)
    trades_completed    Int     @default(0)

    // Activity stats
    items_collected     Int     @default(0)
    items_dropped       Int     @default(0)
    distance_traveled   BigInt  @default(0)  // In game units

    // =========================================================================
    // INDEXES
    // =========================================================================
    @@unique([account_id, profile])
    @@index([name])
    @@index([personality_preset])
    @@index([hardcore_mode])
    @@index([online])
}

// Bot character tags for categorization
model bot_character_tag {
    character_id Int
    tag_id       Int

    @@id([character_id, tag_id])
}

// Gateway connection log
model bot_gateway_log {
    id           Int      @id @default(autoincrement())
    character_id Int
    event        String   // 'connect', 'disconnect', 'error', 'stale'
    timestamp    DateTime @default(now())
    details      String?  @db.Text  // JSON with extra info
}
