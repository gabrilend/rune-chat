#!/bin/bash
# query_all_bots - List all bots known to the gateway
# Protocol: --tool-info for JSON schema, stdin for execution args

GATEWAY_HOST="${GATEWAY_HOST:-localhost}"
GATEWAY_PORT="${GATEWAY_PORT:-8245}"

if [[ "$1" == "--tool-info" ]]; then
    cat << 'EOF'
{"name": "query_all_bots", "description": "List all bots connected to the gateway with their status. Returns bot names, online/offline status, and basic info.", "parameters": {"type": "object", "properties": {}, "required": []}}
EOF
    exit 0
fi

# Consume stdin (may be empty or {})
cat > /dev/null

# Query the gateway status endpoint
response=$(curl -sf "http://${GATEWAY_HOST}:${GATEWAY_PORT}/status" 2>/dev/null)
curl_status=$?

if [[ $curl_status -ne 0 ]] || [[ -z "$response" ]]; then
    echo '{"success": false, "error": "Failed to connect to gateway"}'
    exit 0
fi

# Check for valid JSON (has opening brace)
if [[ ! "$response" =~ ^\{.*\}$ ]]; then
    echo '{"success": false, "error": "Invalid response from gateway"}'
    exit 0
fi

# Extract bots and sdks objects using sed
# The response format is: {"status": "running", "bots": {...}, "sdks": {...}}
bots=$(echo "$response" | sed -n 's/.*"bots"[[:space:]]*:[[:space:]]*\({[^}]*}\).*/\1/p')
sdks=$(echo "$response" | sed -n 's/.*"sdks"[[:space:]]*:[[:space:]]*\({[^}]*}\).*/\1/p')

# Handle empty/nested objects - fallback to empty
[[ -z "$bots" ]] && bots="{}"
[[ -z "$sdks" ]] && sdks="{}"

# For complex nested JSON, just return the whole response with success wrapper
# This is simpler than trying to parse nested JSON in bash
echo "{\"success\": true, \"data\": ${response}}"
